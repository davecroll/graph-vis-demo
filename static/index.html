<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Direct Lending Graph</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1a2e; color: #e0e0e0; min-height: 100vh; }
  header { background: #16213e; padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #0f3460; }
  header h1 { font-size: 1.2rem; color: #e0e0e0; }
  #stats { font-size: 0.85rem; color: #a0a0c0; }
  #stats span { margin-left: 16px; }
  .container { max-width: 1100px; margin: 0 auto; padding: 24px; }
  .tabs { display: flex; gap: 0; margin-bottom: 0; }
  .tab { padding: 10px 28px; background: #0f3460; color: #a0a0c0; border: 1px solid #0f3460; border-bottom: none; border-radius: 8px 8px 0 0; cursor: pointer; font-size: 0.95rem; font-weight: 600; }
  .tab.active { background: #16213e; color: #e0e0e0; border-color: #0f3460; }
  .tab:hover:not(.active) { background: #1a1a4e; }
  table { width: 100%; border-collapse: collapse; background: #16213e; border: 1px solid #0f3460; border-radius: 0 8px 8px 8px; overflow: hidden; }
  thead th { text-align: left; padding: 10px 14px; font-size: 0.8rem; color: #a0a0c0; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #0f3460; background: #16213e; }
  tbody tr { cursor: pointer; transition: background 0.15s; }
  tbody tr:hover { background: #1a1a4e; }
  tbody td { padding: 10px 14px; font-size: 0.9rem; border-bottom: 1px solid #0f3460; }
  tbody td:last-child { text-align: right; }
  thead th:last-child { text-align: right; }
  .num { font-variant-numeric: tabular-nums; }
  #loading { text-align: center; padding: 60px; color: #a0a0c0; font-size: 1.1rem; }
</style>
</head>
<body>
<header>
  <h1>Direct Lending Network</h1>
  <div id="stats">Loading...</div>
</header>
<div class="container">
  <div class="tabs">
    <div class="tab active" data-tab="borrowers">Borrowers</div>
    <div class="tab" data-tab="lenders">Lenders</div>
  </div>
  <div id="borrowers-table"></div>
  <div id="lenders-table" style="display:none;"></div>
  <div id="loading">Loading...</div>
</div>
<script>
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    const target = tab.dataset.tab;
    document.getElementById('borrowers-table').style.display = target === 'borrowers' ? '' : 'none';
    document.getElementById('lenders-table').style.display = target === 'lenders' ? '' : 'none';
  });
});

async function loadStats() {
  try {
    const res = await fetch('/api/stats');
    const data = await res.json();
    document.getElementById('stats').innerHTML =
      `<span>Borrowers: ${data.borrowers}</span>` +
      `<span>Lenders: ${data.lenders}</span>` +
      `<span>Deals: ${data.deals}</span>` +
      `<span>Total Volume: $${data.total_deal_volume_mm}MM</span>`;
  } catch (e) {
    document.getElementById('stats').textContent = 'Stats unavailable';
  }
}

function fmt(v) { return v != null ? `$${v}MM` : ''; }

async function loadEntities() {
  try {
    const res = await fetch('/api/entities');
    const data = await res.json();
    document.getElementById('loading').remove();

    // Borrowers table
    let bHtml = '<table><thead><tr><th>Name</th><th>Sector</th><th>HQ</th><th>Deals</th><th>Total Volume</th></tr></thead><tbody>';
    for (const b of data.borrowers) {
      const url = `/entity/Borrower/${encodeURIComponent(b.name)}`;
      bHtml += `<tr onclick="location.href='${url}'">`;
      bHtml += `<td>${b.name}</td>`;
      bHtml += `<td>${b.sector || ''}</td>`;
      bHtml += `<td>${b.hq || ''}</td>`;
      bHtml += `<td class="num">${b.deal_count}</td>`;
      bHtml += `<td class="num">${fmt(b.total_volume_mm)}</td>`;
      bHtml += '</tr>';
    }
    bHtml += '</tbody></table>';
    document.getElementById('borrowers-table').innerHTML = bHtml;

    // Lenders table
    let lHtml = '<table><thead><tr><th>Name</th><th>Type</th><th>AUM</th><th>Deals</th><th>Total Commitment</th></tr></thead><tbody>';
    for (const l of data.lenders) {
      const url = `/entity/Lender/${encodeURIComponent(l.name)}`;
      lHtml += `<tr onclick="location.href='${url}'">`;
      lHtml += `<td>${l.name}</td>`;
      lHtml += `<td>${l.type || ''}</td>`;
      lHtml += `<td>${l.aum_bn != null ? '$' + l.aum_bn + 'B' : ''}</td>`;
      lHtml += `<td class="num">${l.deal_count}</td>`;
      lHtml += `<td class="num">${fmt(l.total_commitment_mm)}</td>`;
      lHtml += '</tr>';
    }
    lHtml += '</tbody></table>';
    document.getElementById('lenders-table').innerHTML = lHtml;
  } catch (e) {
    document.getElementById('loading').textContent = 'Error loading data.';
  }
}

loadStats();
loadEntities();
</script>
</body>
</html>
